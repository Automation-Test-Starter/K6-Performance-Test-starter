<!-- markdownlint-disable MD041 -->
<!-- markdownlint-disable MD033 -->
<div align="right"><strong>ğŸ‡¨ğŸ‡³ä¸­æ–‡</a></strong>  | <strong><a href="./README.md">ğŸ‡¬ğŸ‡§English</strong></div>
<!-- markdownlint-disable MD041 -->
<!-- markdownlint-disable MD033 -->

# K6 æ€§èƒ½æµ‹è¯•å¿«é€Ÿå¯åŠ¨é¡¹ç›®

ä¸€ä¸ªå…³äºä½¿ç”¨ K6 è¿›è¡Œæ€§èƒ½æµ‹è¯•çš„å¿«é€Ÿå¯åŠ¨ä»‹ç»æ€§æ–‡æ¡£ã€‚

- [K6 æ€§èƒ½æµ‹è¯•å¿«é€Ÿå¯åŠ¨é¡¹ç›®](#k6-æ€§èƒ½æµ‹è¯•å¿«é€Ÿå¯åŠ¨é¡¹ç›®)
  - [ä»€ä¹ˆæ˜¯ K6](#ä»€ä¹ˆæ˜¯-k6)
  - [å®˜æ–¹ç½‘ç«™åŠæ–‡æ¡£](#å®˜æ–¹ç½‘ç«™åŠæ–‡æ¡£)
  - [å®‰è£…](#å®‰è£…)
    - [Mac ç³»ç»Ÿå®‰è£…](#mac-ç³»ç»Ÿå®‰è£…)
    - [Windows ç³»ç»Ÿå®‰è£…](#windows-ç³»ç»Ÿå®‰è£…)
    - [Docker å®‰è£…](#docker-å®‰è£…)
    - [å…¶ä»–ç³»ç»Ÿå®‰è£…](#å…¶ä»–ç³»ç»Ÿå®‰è£…)
    - [ç¡®è®¤ K6 å®‰è£…æˆåŠŸ](#ç¡®è®¤-k6-å®‰è£…æˆåŠŸ)
  - [ç¬¬ä¸€ä¸ª K6 æµ‹è¯•è„šæœ¬](#ç¬¬ä¸€ä¸ª-k6-æµ‹è¯•è„šæœ¬)
    - [ç¼–å†™ç¬¬ä¸€ä¸ªæµ‹è¯•è„šæœ¬](#ç¼–å†™ç¬¬ä¸€ä¸ªæµ‹è¯•è„šæœ¬)
      - [æ–°å»ºä¸€ä¸ª K6 æ€§èƒ½æµ‹è¯•é¡¹ç›®ç›®å½•å¹¶è¿›å…¥](#æ–°å»ºä¸€ä¸ª-k6-æ€§èƒ½æµ‹è¯•é¡¹ç›®ç›®å½•å¹¶è¿›å…¥)
      - [åˆ›å»ºä¸€ä¸ªåä¸º `demo.js` çš„æ–‡ä»¶ï¼Œç”¨äºç¼–å†™æµ‹è¯•è„šæœ¬](#åˆ›å»ºä¸€ä¸ªåä¸º-demojs-çš„æ–‡ä»¶ç”¨äºç¼–å†™æµ‹è¯•è„šæœ¬)
      - [ç¼–è¾‘æµ‹è¯•è„šæœ¬](#ç¼–è¾‘æµ‹è¯•è„šæœ¬)
      - [è¿è¡Œæµ‹è¯•è„šæœ¬](#è¿è¡Œæµ‹è¯•è„šæœ¬)
      - [æŸ¥çœ‹æµ‹è¯•ç»“æœ](#æŸ¥çœ‹æµ‹è¯•ç»“æœ)
      - [è§£æ demo æµ‹è¯•è„šæœ¬](#è§£æ-demo-æµ‹è¯•è„šæœ¬)
  - [K6 å¸¸ç”¨åŠŸèƒ½](#k6-å¸¸ç”¨åŠŸèƒ½)
    - [HTTP Requests](#http-requests)
      - [GET è¯·æ±‚ä¾‹å­](#get-è¯·æ±‚ä¾‹å­)
      - [POST è¯·æ±‚ä¾‹å­](#post-è¯·æ±‚ä¾‹å­)
      - [æ”¯æŒçš„ HTTP æ–¹æ³•](#æ”¯æŒçš„-http-æ–¹æ³•)
      - [HTTP è¯·æ±‚æ ‡ç­¾](#http-è¯·æ±‚æ ‡ç­¾)
    - [Metrics æŒ‡æ ‡](#metrics-æŒ‡æ ‡)
      - [K6 å†…ç½®æŒ‡æ ‡](#k6-å†…ç½®æŒ‡æ ‡)
        - [æ ‡å‡†å†…ç½®æŒ‡æ ‡](#æ ‡å‡†å†…ç½®æŒ‡æ ‡)
        - [HTTP ç‰¹å®šçš„å†…ç½®æŒ‡æ ‡](#http-ç‰¹å®šçš„å†…ç½®æŒ‡æ ‡)
        - [å…¶ä»–å†…ç½®æŒ‡æ ‡](#å…¶ä»–å†…ç½®æŒ‡æ ‡)
      - [è‡ªå®šä¹‰æŒ‡æ ‡](#è‡ªå®šä¹‰æŒ‡æ ‡)
        - [è‡ªå®šä¹‰æŒ‡æ ‡ demo ç¤ºä¾‹](#è‡ªå®šä¹‰æŒ‡æ ‡-demo-ç¤ºä¾‹)
          - [1.ä»å¯¼å…¥ k6/metrics æ¨¡å—å¼•å…¥ Trend æ„é€ å‡½æ•°](#1ä»å¯¼å…¥-k6metrics-æ¨¡å—å¼•å…¥-trend-æ„é€ å‡½æ•°)
          - [2.åœ¨ init ä¸Šä¸‹æ–‡ä¸­æ„é€ ä¸€ä¸ªæ–°çš„è‡ªå®šä¹‰åº¦é‡ Trend å¯¹è±¡](#2åœ¨-init-ä¸Šä¸‹æ–‡ä¸­æ„é€ ä¸€ä¸ªæ–°çš„è‡ªå®šä¹‰åº¦é‡-trend-å¯¹è±¡)
          - [3.åœ¨è„šæœ¬ä¸­ä½¿ç”¨ add æ–¹æ³•è®°å½•æŒ‡æ ‡æµ‹é‡å€¼](#3åœ¨è„šæœ¬ä¸­ä½¿ç”¨-add-æ–¹æ³•è®°å½•æŒ‡æ ‡æµ‹é‡å€¼)
          - [4.demo\_custom\_metrics.js è‡ªå®šä¹‰æŒ‡æ ‡å®Œæ•´ä»£ç ](#4demo_custom_metricsjs-è‡ªå®šä¹‰æŒ‡æ ‡å®Œæ•´ä»£ç )
          - [5.è¿è¡Œ demo\_custom\_metrics.js å¹¶æŸ¥çœ‹è‡ªåŠ¨åŒ–è¶‹åŠ¿æŒ‡æ ‡](#5è¿è¡Œ-demo_custom_metricsjs-å¹¶æŸ¥çœ‹è‡ªåŠ¨åŒ–è¶‹åŠ¿æŒ‡æ ‡)
  - [å‚è€ƒèµ„æ–™](#å‚è€ƒèµ„æ–™)

## ä»€ä¹ˆæ˜¯ K6

k6 æ˜¯ä¸€æ¬¾ç”¨äºæ€§èƒ½æµ‹è¯•å’Œè´Ÿè½½æµ‹è¯•çš„å¼€æºå·¥å…·ï¼Œä¸»è¦ç”¨äºè¯„ä¼°å’ŒéªŒè¯åº”ç”¨ç¨‹åºçš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚ä»¥ä¸‹æ˜¯å…³äº k6 çš„ä¸€äº›ä¸»è¦ç‰¹ç‚¹å’Œä¿¡æ¯ï¼š

1. **å¼€æºæ€§ï¼š** k6 æ˜¯ä¸€æ¬¾å®Œå…¨å¼€æºçš„æ€§èƒ½æµ‹è¯•å·¥å…·ï¼Œä»£ç å­˜å‚¨åœ¨ GitHub ä¸Šã€‚è¿™æ„å‘³ç€ç”¨æˆ·å¯ä»¥è‡ªç”±è®¿é—®ã€ä½¿ç”¨å’Œä¿®æ”¹å·¥å…·çš„æºä»£ç ã€‚

2. **JavaScript ç¼–å†™è„šæœ¬ï¼š** k6 ä½¿ç”¨ JavaScript è¯­è¨€ç¼–å†™æµ‹è¯•è„šæœ¬ï¼Œè¿™ä½¿å¾—ç¼–å†™æµ‹è¯•ç”¨ä¾‹ç›¸å¯¹ç®€å•ï¼Œå¹¶ä¸”å¯¹äºå¼€å‘äººå‘˜è€Œè¨€æ›´åŠ å‹å¥½ã€‚è„šæœ¬å¯ä»¥åŒ…å« HTTP è¯·æ±‚ã€WebSocket è¿æ¥ã€è„šæœ¬æ‰§è¡Œé€»è¾‘ç­‰ã€‚

3. **æ”¯æŒå¤šç§åè®®ï¼š** k6 æ”¯æŒå¤šç§å¸¸è§çš„åè®®ï¼ŒåŒ…æ‹¬ HTTPã€WebSocketã€Socket.IOã€gRPC ç­‰ï¼Œä½¿å…¶å¯ä»¥å¹¿æ³›åº”ç”¨äºå„ç§ç±»å‹çš„åº”ç”¨ç¨‹åºã€‚

4. **åˆ†å¸ƒå¼æµ‹è¯•ï¼š** k6 å…·æœ‰åˆ†å¸ƒå¼æµ‹è¯•çš„èƒ½åŠ›ï¼Œå…è®¸åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œæµ‹è¯•ï¼Œä»è€Œæ¨¡æ‹Ÿæ›´çœŸå®çš„ç”Ÿäº§ç¯å¢ƒè´Ÿè½½ã€‚

5. **å®æ—¶ç»“æœå’ŒæŠ¥å‘Šï¼š** k6 æä¾›å®æ—¶ç»“æœï¼ŒåŒ…æ‹¬è¯·æ±‚å“åº”æ—¶é—´ã€ååé‡ç­‰ï¼Œå¹¶èƒ½å¤Ÿç”Ÿæˆè¯¦ç»†çš„ HTML æŠ¥å‘Šï¼Œå¸®åŠ©ç”¨æˆ·æ›´å¥½åœ°ç†è§£åº”ç”¨ç¨‹åºçš„æ€§èƒ½çŠ¶å†µã€‚

6. **å®¹å™¨åŒ–æ”¯æŒï¼š** k6 é€‚åº”å®¹å™¨åŒ–ç¯å¢ƒï¼Œå¯ä»¥è½»æ¾é›†æˆåˆ° CI/CD æµæ°´çº¿ä¸­ï¼Œå¹¶ä¸å¸¸è§çš„å®¹å™¨ç¼–æ’å·¥å…·ï¼ˆå¦‚ Kubernetesï¼‰é…åˆä½¿ç”¨ã€‚

7. **æ’ä»¶ç”Ÿæ€ç³»ç»Ÿï¼š** k6 æ”¯æŒæ’ä»¶ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡æ’ä»¶æ‰©å±•å…¶åŠŸèƒ½ï¼Œæ»¡è¶³ç‰¹å®šéœ€æ±‚ã€‚

8. **æ´»è·ƒçš„ç¤¾åŒºï¼š** ç”±äº k6 æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œæ‹¥æœ‰ä¸€ä¸ªç§¯æçš„ç¤¾åŒºï¼Œæä¾›æ”¯æŒã€æ–‡æ¡£å’Œç¤ºä¾‹ï¼Œä½¿ç”¨æˆ·æ›´å®¹æ˜“ä¸Šæ‰‹å’Œè§£å†³é—®é¢˜ã€‚

æ€»ä½“è€Œè¨€ï¼Œk6 æ˜¯ä¸€ä¸ªçµæ´»ã€å¼ºå¤§ä¸”æ˜“äºä½¿ç”¨çš„æ€§èƒ½æµ‹è¯•å·¥å…·ï¼Œé€‚ç”¨äºå„ç§è§„æ¨¡çš„åº”ç”¨ç¨‹åºå’Œç³»ç»Ÿã€‚

## å®˜æ–¹ç½‘ç«™åŠæ–‡æ¡£

- [å®˜æ–¹ç½‘ç«™](https://k6.io/)
- [å®˜æ–¹æ–‡æ¡£](https://k6.io/docs/)

## å®‰è£…

### Mac ç³»ç»Ÿå®‰è£…

Mac ç³»ç»Ÿå¯ä»¥é€šè¿‡ Homebrew å®‰è£… k6ï¼š

```bash
brew install k6
```

### Windows ç³»ç»Ÿå®‰è£…

Windows ç³»ç»Ÿå¯ä»¥é€šè¿‡ Chocolatey å®‰è£… k6ï¼š

```bash
choco install k6
```

æˆ–è€…é€šè¿‡ winget å®‰è£… k6ï¼š

```bash
winget install k6
```

### Docker å®‰è£…

k6 ä¹Ÿå¯ä»¥é€šè¿‡ Docker å®‰è£…ï¼š

```bash
docker pull grafana/k6
```

### å…¶ä»–ç³»ç»Ÿå®‰è£…

K6 é™¤äº†æ”¯æŒä¸Šè¿°ç³»ç»Ÿå¤–ï¼Œè¿˜æ”¯æŒ Linuxï¼ˆDebian/Ubuntu/Fedora/CentOSï¼‰ï¼Œä¹Ÿæ”¯æŒä¸‹è½½ K6 äºŒè¿›åˆ¶æ–‡ä»¶å’Œ K6 æ‰©å±•è¿›è¡Œå®‰è£…ï¼Œå…·ä½“å®‰è£…æ–¹å¼è¯·å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://k6.io/docs/get-started/installation)ã€‚

### ç¡®è®¤ K6 å®‰è£…æˆåŠŸ

å®‰è£…å®Œæˆåï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ç¡®è®¤ k6 æ˜¯å¦å®‰è£…æˆåŠŸï¼š

```bash
k6 version
```

å¦‚æœå®‰è£…æˆåŠŸï¼Œä¼šæ˜¾ç¤º k6 çš„ç‰ˆæœ¬ä¿¡æ¯ï¼š

![ ](https://cdn.jsdelivr.net/gh/naodeng/blogimg@master/uPic/QR8wKb.png)

## ç¬¬ä¸€ä¸ª K6 æµ‹è¯•è„šæœ¬

### ç¼–å†™ç¬¬ä¸€ä¸ªæµ‹è¯•è„šæœ¬

#### æ–°å»ºä¸€ä¸ª K6 æ€§èƒ½æµ‹è¯•é¡¹ç›®ç›®å½•å¹¶è¿›å…¥

```bash
mkdir k6-demo
cd k6-demo
```

#### åˆ›å»ºä¸€ä¸ªåä¸º `demo.js` çš„æ–‡ä»¶ï¼Œç”¨äºç¼–å†™æµ‹è¯•è„šæœ¬

- å¯ä»¥é€šè¿‡ `k6 new` å‘½ä»¤åˆ›å»ºä¸€ä¸ªæµ‹è¯•è„šæœ¬æ–‡ä»¶ï¼š

```bash
k6 new demo.js
```

- ä¹Ÿå¯ä»¥ç›´æ¥åˆ›å»ºä¸€ä¸ªåä¸º demo.js çš„æµ‹è¯•è„šæœ¬æ–‡ä»¶

```bash
touch demo.js
```

#### ç¼–è¾‘æµ‹è¯•è„šæœ¬

å¦‚æœæ˜¯é€šè¿‡ `k6 new` å‘½ä»¤åˆ›å»ºçš„æµ‹è¯•è„šæœ¬æ–‡ä»¶ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªç®€å•çš„æµ‹è¯•è„šæœ¬ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```javascript
import http from 'k6/http';
import { sleep } from 'k6';

export const options = {
  // A number specifying the number of VUs to run concurrently.
  vus: 10,
  // A string specifying the total duration of the test run.
  duration: '30s',

  // The following section contains configuration options for execution of this
  // test script in Grafana Cloud.
  //
  // See https://grafana.com/docs/grafana-cloud/k6/get-started/run-cloud-tests-from-the-cli/
  // to learn about authoring and running k6 test scripts in Grafana k6 Cloud.
  //
  // ext: {
  //   loadimpact: {
  //     // The ID of the project to which the test is assigned in the k6 Cloud UI.
  //     // By default tests are executed in default project.
  //     projectID: "",
  //     // The name of the test in the k6 Cloud UI.
  //     // Test runs with the same name will be grouped.
  //     name: "demo.js"
  //   }
  // },

  // Uncomment this section to enable the use of Browser API in your tests.
  //
  // See https://grafana.com/docs/k6/latest/using-k6-browser/running-browser-tests/ to learn more
  // about using Browser API in your test scripts.
  //
  // scenarios: {
  //   // The scenario name appears in the result summary, tags, and so on.
  //   // You can give the scenario any name, as long as each name in the script is unique.
  //   ui: {
  //     // Executor is a mandatory parameter for browser-based tests.
  //     // Shared iterations in this case tells k6 to reuse VUs to execute iterations.
  //     //
  //     // See https://grafana.com/docs/k6/latest/using-k6/scenarios/executors/ for other executor types.
  //     executor: 'shared-iterations',
  //     options: {
  //       browser: {
  //         // This is a mandatory parameter that instructs k6 to launch and
  //         // connect to a chromium-based browser, and use it to run UI-based
  //         // tests.
  //         type: 'chromium',
  //       },
  //     },
  //   },
  // }
};

// The function that defines VU logic.
//
// See https://grafana.com/docs/k6/latest/examples/get-started-with-k6/ to learn more
// about authoring k6 scripts.
//
export default function() {
  http.get('https://test.k6.io');
  sleep(1);
}
```

å¦‚æœæ˜¯ç›´æ¥åˆ›å»ºçš„æµ‹è¯•è„šæœ¬æ–‡ä»¶ï¼Œå¯ä»¥å°†ä¸Šè¿°å†…å®¹å¤åˆ¶åˆ° `demo.js` æ–‡ä»¶ä¸­ã€‚

#### è¿è¡Œæµ‹è¯•è„šæœ¬

åœ¨ `demo.js` æ–‡ä»¶æ‰€åœ¨ç›®å½•ä¸‹ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
k6 run demo.js
```

#### æŸ¥çœ‹æµ‹è¯•ç»“æœ

å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œä¼šçœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹çš„è¾“å‡ºï¼š

![ ](https://cdn.jsdelivr.net/gh/naodeng/blogimg@master/uPic/a4vK69.png)

åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š

- **execution:** æ‰§è¡Œä¿¡æ¯ï¼ŒåŒ…æ‹¬å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´ã€æŒç»­æ—¶é—´ã€VU æ•°é‡ã€è¿­ä»£æ¬¡æ•°ç­‰ã€‚
- **scenarios:** åœºæ™¯ä¿¡æ¯ï¼ŒåŒ…æ‹¬åœºæ™¯åç§°ã€VU æ•°é‡ã€è¿­ä»£æ¬¡æ•°ã€æŒç»­æ—¶é—´ã€å¹³å‡å“åº”æ—¶é—´ã€ååé‡ç­‰ã€‚
- **http_reqs:** HTTP è¯·æ±‚ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¯·æ±‚åç§°ã€è¯·æ±‚æ•°é‡ã€å¤±è´¥æ•°é‡ã€å¹³å‡å“åº”æ—¶é—´ã€ååé‡ç­‰ã€‚

#### è§£æ demo æµ‹è¯•è„šæœ¬

- `import http from 'k6/http';`ï¼šå¯¼å…¥ k6 çš„ HTTP æ¨¡å—ï¼Œç”¨äºå‘é€ HTTP è¯·æ±‚ã€‚

- `import { sleep } from 'k6';`ï¼šå¯¼å…¥ k6 çš„ sleep æ–¹æ³•ï¼Œç”¨äºæ‰§è¡Œè„šæœ¬ç­‰å¾…ã€‚

- `export const options = { ... }`ï¼šå®šä¹‰æµ‹è¯•è„šæœ¬çš„é…ç½®é¡¹ï¼ŒåŒ…æ‹¬ VU æ•°é‡ã€æŒç»­æ—¶é—´ç­‰ã€‚

- `vus: 10,`ï¼šå®šä¹‰ VU æ•°é‡ä¸º 10ï¼ˆæŒ‡å®šå¹¶å‘è¿è¡Œçš„ VU æ•°é‡ï¼‰ã€‚

- `duration: '30s',`ï¼šå®šä¹‰æŒç»­æ—¶é—´ä¸º 30 ç§’ï¼ˆæŒ‡å®šæµ‹è¯•è¿è¡Œæ€»æŒç»­æ—¶é—´ï¼‰ã€‚

- `export default function() { ... }`ï¼šå®šä¹‰æµ‹è¯•è„šæœ¬çš„é€»è¾‘ï¼ŒåŒ…æ‹¬å‘é€ HTTP è¯·æ±‚ã€æ‰§è¡Œç­‰å¾…ç­‰ã€‚

- `http.get('https://test.k6.io');`ï¼šå‘é€ä¸€ä¸ª GET è¯·æ±‚åˆ° `https://test.k6.io`ã€‚

- `sleep(1);`ï¼šæ‰§è¡Œç­‰å¾… 1 ç§’ã€‚

> å…¶ä»–æ³¨é‡Šå†…å®¹å¯ä»¥å¿½ç•¥ï¼Œè¿™äº›å†…å®¹æ˜¯å…³äº k6 çš„ä¸€äº›é«˜çº§åŠŸèƒ½ï¼Œåç»­ä¼šä»‹ç»ã€‚

## K6 å¸¸ç”¨åŠŸèƒ½

### HTTP Requests

ä½¿ç”¨ K6 è¿›è¡Œæ€§èƒ½æµ‹è¯•çš„ç¬¬ä¸€æ­¥å°±æ˜¯å®šä¹‰è¦æµ‹è¯•çš„ HTTP è¯·æ±‚ã€‚

#### GET è¯·æ±‚ä¾‹å­

ä½¿ç”¨ `k6 new` å‘½ä»¤åˆ›å»ºçš„ demo æµ‹è¯•è„šæœ¬ä¸­ï¼Œå·²ç»åŒ…å«äº†ä¸€ä¸ªç®€å•çš„ GET æ–¹æ³• HTTP è¯·æ±‚ï¼š

```javascript
import http from 'k6/http';
import { sleep } from 'k6';

export default function() {
  http.get('https://test.k6.io');
  sleep(1);
}
```

#### POST è¯·æ±‚ä¾‹å­

è¿™ä¸ª POST è¯·æ±‚ä¾‹å­å±•ç¤ºä¸€äº›å¤æ‚çš„åœºæ™¯çš„åº”ç”¨ï¼ˆå¸¦æœ‰ç”µå­é‚®ä»¶/å¯†ç èº«ä»½éªŒè¯è´Ÿè½½çš„ POST è¯·æ±‚ï¼‰

```javascript
import http from 'k6/http';

export default function () {
  const url = 'http://test.k6.io/login';
  const payload = JSON.stringify({
    email: 'aaa',
    password: 'bbb',
  });

  const params = {
    headers: {
      'Content-Type': 'application/json',
    },
  };

  http.post(url, payload, params);
}

```

> ä»¥ä¸Šå†…å®¹å‚è€ƒè‡ª [K6 å®˜æ–¹æ–‡æ¡£](https://k6.io/docs/using-k6/http-requests)

#### æ”¯æŒçš„ HTTP æ–¹æ³•

K6 æä¾›çš„ HTTP æ¨¡å—èƒ½å¤„ç†å„ç§ HTTP è¯·æ±‚å’Œæ–¹æ³•ã€‚ä»¥ä¸‹æ˜¯æ”¯æŒçš„ HTTP æ–¹æ³•åˆ—è¡¨ï¼š

| æ–¹æ³• | ä½œç”¨ |
| ------- | ------- |
| batch()| å¹¶è¡Œå‘å‡ºå¤šä¸ª HTTP è¯·æ±‚ï¼ˆä¾‹å¦‚æµè§ˆå™¨å¾€å¾€ä¼šè¿™æ ·åšï¼‰ã€‚|
| del() | å‘å‡º HTTP DELETE è¯·æ±‚ã€‚|
| get() | å‘å‡º HTTP GET è¯·æ±‚ã€‚|
| head() | å‘å‡º HTTP HEAD è¯·æ±‚ã€‚|
| options() | å‘å‡º HTTP OPTIONS è¯·æ±‚ã€‚|
| patch() | å‘å‡º HTTP PATCH è¯·æ±‚ã€‚|
| post() | å‘å‡º HTTP POST è¯·æ±‚ã€‚|
| put() | å‘å‡º HTTP PUT è¯·æ±‚ã€‚|
| request() | å‘å‡ºä»»ä½•ç±»å‹çš„ HTTP è¯·æ±‚ã€‚|

#### HTTP è¯·æ±‚æ ‡ç­¾

K6 å…è®¸ä¸ºæ¯ä¸ª HTTP è¯·æ±‚æ·»åŠ æ ‡ç­¾ï¼Œç»“åˆæ ‡ç­¾å’Œåˆ†ç»„ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„åœ¨æµ‹è¯•ç»“æœä¸­æ›´å¥½åœ°ç»„ç»‡ï¼Œåˆ†ç»„è¯·æ±‚å’Œè¿‡æ»¤ç»“æœç»„ç»‡åˆ†æã€‚

ä»¥ä¸‹ä¸ºæ”¯æŒçš„æ ‡ç­¾åˆ—è¡¨ï¼š

| æ ‡ç­¾ | ä½œç”¨ |
| ------- | ------- |
| name | è¯·æ±‚åç§°ã€‚é»˜è®¤ä¸ºè¯·æ±‚çš„ URL|
| method | è¯·æ±‚æ–¹æ³•ï¼ˆGETã€POSTã€PUT ç­‰ï¼‰|
| url | é»˜è®¤ä¸ºè¯·æ±‚çš„ URLã€‚|
| expected_response | é»˜è®¤æƒ…å†µä¸‹ï¼Œ200 åˆ° 399 ä¹‹é—´çš„å“åº”çŠ¶æ€ä¸º trueã€‚ä½¿ç”¨ setResponseCallback æ›´æ”¹é»˜è®¤è¡Œä¸ºã€‚|
| group | å½“è¯·æ±‚åœ¨ç»„å†…è¿è¡Œæ—¶ï¼Œæ ‡è®°å€¼æ˜¯ç»„åç§°ã€‚é»˜è®¤ä¸ºç©ºã€‚|
| scenario | å½“è¯·æ±‚åœ¨åœºæ™¯å†…è¿è¡Œæ—¶ï¼Œæ ‡è®°å€¼æ˜¯åœºæ™¯åç§°ã€‚é»˜è®¤ä¸º defaultã€‚|
| status | å“åº”çŠ¶æ€|

HTTP è¯·æ±‚ä½¿ç”¨ tag å’Œ group æ ‡ç­¾çš„ä¾‹å­ä¼šåœ¨åç»­çš„ demo ä¸­å±•ç¤ºã€‚

å¤§å®¶ä¹Ÿå¯ä»¥å‚è€ƒå®˜æ–¹çš„ä¾‹å­ï¼š[https://grafana.com/docs/k6/latest/using-k6/http-requests/](https://grafana.com/docs/k6/latest/using-k6/http-requests/)

### Metrics æŒ‡æ ‡

æŒ‡æ ‡ç”¨äºè¡¡é‡ç³»ç»Ÿåœ¨æµ‹è¯•æ¡ä»¶ä¸‹çš„æ€§èƒ½ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œk6 ä¼šè‡ªåŠ¨æ”¶é›†å†…ç½®æŒ‡æ ‡ã€‚é™¤äº†å†…ç½®æŒ‡æ ‡ï¼Œæ‚¨è¿˜å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰æŒ‡æ ‡ã€‚

æŒ‡æ ‡ä¸€èˆ¬åˆ†ä¸ºå››å¤§ç±»ï¼š

1. è®¡æ•°å™¨ï¼ˆCountersï¼‰ï¼šå¯¹å€¼æ±‚å’Œã€‚
2. è®¡é‡å™¨ï¼ˆGaugesï¼‰ï¼šè·Ÿè¸ªæœ€å°ã€æœ€å¤§å’Œæœ€æ–°çš„å€¼ã€‚
3. æ¯”ç‡ï¼ˆRatesï¼‰ï¼šè·Ÿè¸ªéé›¶å€¼å‘ç”Ÿçš„é¢‘ç‡ã€‚
4. è¶‹åŠ¿ï¼ˆTrendsï¼‰ï¼šè®¡ç®—å¤šä¸ªå€¼çš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆå¦‚å‡å€¼ã€æ¨¡å¼æˆ–ç™¾åˆ†ä½æ•°ï¼‰ã€‚

è¦ä½¿æµ‹è¯•æ–­è¨€ç¬¦åˆéœ€æ±‚æ ‡å‡†ï¼Œå¯ä»¥æ ¹æ®æ€§èƒ½æµ‹è¯•è¦æ±‚çš„æŒ‡æ ‡æ¡ä»¶ç¼–å†™é˜ˆå€¼ï¼ˆè¡¨è¾¾å¼çš„å…·ä½“å†…å®¹å–å†³äºæŒ‡æ ‡ç±»å‹ï¼‰ã€‚

ä¸ºäº†åç»­è¿›è¡Œç­›é€‰æŒ‡æ ‡ï¼Œå¯ä»¥ä½¿ç”¨æ ‡ç­¾å’Œåˆ†ç»„ï¼Œè¿™æ ·å¯ä»¥æ›´å¥½åœ°ç»„ç»‡æµ‹è¯•ç»“æœã€‚

> æµ‹è¯•ç»“æœè¾“å‡ºæ–‡ä»¶å¯ä»¥ä»¥å„ç§æ‘˜è¦å’Œç»†ç²’åº¦æ ¼å¼å¯¼å‡ºæŒ‡æ ‡ï¼Œå…·ä½“ä¿¡æ¯è¯·å‚é˜…ç»“æœè¾“å‡ºæ–‡æ¡£ã€‚ï¼ˆåé¢æµ‹è¯•ç»“æœè¾“å‡ºæ–‡æ¡£ä¼šè¯¦ç»†ä»‹ç»è¿™ä¸€éƒ¨åˆ†ï¼‰

#### K6 å†…ç½®æŒ‡æ ‡

æ¯ä¸ª k6 æµ‹è¯•æ‰§è¡Œéƒ½ä¼šå‘å‡ºå†…ç½®å’Œè‡ªå®šä¹‰æŒ‡æ ‡ã€‚æ¯ä¸ªæ”¯æŒçš„åè®®ä¹Ÿæœ‰å…¶ç‰¹å®šçš„æŒ‡æ ‡ã€‚

##### æ ‡å‡†å†…ç½®æŒ‡æ ‡

æ— è®ºæµ‹è¯•ä½¿ç”¨ä»€ä¹ˆåè®®ï¼Œk6 å§‹ç»ˆæ”¶é›†ä»¥ä¸‹æŒ‡æ ‡ï¼š

| æŒ‡æ ‡åç§° | æŒ‡æ ‡åˆ†ç±» | æŒ‡æ ‡æè¿° |
| ------- | ------- | -------|
| vus| Gauge |å½“å‰æ´»è·ƒè™šæ‹Ÿç”¨æˆ·æ•° |
| vus_max | Gauge | æœ€å¤§å¯èƒ½è™šæ‹Ÿç”¨æˆ·æ•°ï¼ˆVU èµ„æºå·²é¢„å…ˆåˆ†é…ï¼Œä»¥é¿å…æ‰©å¤§è´Ÿè½½æ—¶å½±å“æ€§èƒ½ï¼‰|
|iterations è¿­ä»£|Counter |VU æ‰§è¡Œ JS è„šæœ¬ï¼ˆdefault å‡½æ•°ï¼‰çš„æ€»æ¬¡æ•°ã€‚|
|iteration_duration|Trend|å®Œæˆä¸€æ¬¡å®Œæ•´è¿­ä»£çš„æ—¶é—´ï¼ŒåŒ…æ‹¬åœ¨ setup å’Œ teardown ä¸­èŠ±è´¹çš„æ—¶é—´ã€‚è¦è®¡ç®—ç‰¹å®šåœºæ™¯çš„è¿­ä»£å‡½æ•°çš„æŒç»­æ—¶é—´ï¼Œè¯·å°è¯•æ­¤è§£å†³æ–¹æ³•|
|dropped_iterations|Counter|ç”±äºç¼ºå°‘ VUï¼ˆå¯¹äºåˆ°è¾¾ç‡æ‰§è¡Œç¨‹åºï¼‰æˆ–æ—¶é—´ä¸è¶³ï¼ˆåŸºäºè¿­ä»£çš„æ‰§è¡Œç¨‹åºä¸­çš„ maxDuration å·²è¿‡æœŸï¼‰è€Œæœªå¯åŠ¨çš„è¿­ä»£æ¬¡æ•°ã€‚å…³äºåˆ é™¤è¿­ä»£|
|data_received|Counter|æ¥æ”¶åˆ°çš„æ•°æ®é‡ã€‚æ­¤ç¤ºä¾‹ä»‹ç»å¦‚ä½•è·Ÿè¸ªå•ä¸ª URL çš„æ•°æ®ã€‚|
|data_sent |Counter|å‘é€çš„æ•°æ®é‡ã€‚è·Ÿè¸ªå•ä¸ª URL çš„æ•°æ®ä»¥è·Ÿè¸ªå•ä¸ª URL çš„æ•°æ®ã€‚|
|checks|Rate|è®¾ç½®çš„æ£€æŸ¥æˆåŠŸç‡ã€‚|

> æŒ‡æ ‡åˆ†ç±»åˆ†åˆ«ä¸ºï¼šè®¡æ•°å™¨ï¼ˆCounterï¼‰ã€è®¡é‡å™¨ï¼ˆGaugesï¼‰ã€æ¯”ç‡ï¼ˆRatesï¼‰ã€è¶‹åŠ¿ï¼ˆTrendsï¼‰

##### HTTP ç‰¹å®šçš„å†…ç½®æŒ‡æ ‡

HTTP ç‰¹å®šçš„å†…ç½®æŒ‡æ ‡æ˜¯ä»…åœ¨ HTTP è¯·æ±‚æœŸé—´æ‰ä¼šç”Ÿæˆå’Œæ”¶é›†çš„æŒ‡æ ‡ã€‚å…¶ä»–ç±»å‹çš„è¯·æ±‚ï¼ˆä¾‹å¦‚ WebSocketï¼‰ä¸ä¼šç”Ÿæˆè¿™äº›æŒ‡æ ‡ã€‚

> æ³¨æ„ï¼šå¯¹äºæ‰€æœ‰ http_req_* æŒ‡æ ‡ï¼Œæ—¶é—´æˆ³åœ¨è¯·æ±‚ç»“æŸæ—¶å‘å‡ºã€‚æ¢å¥è¯è¯´ï¼Œæ—¶é—´æˆ³å‘ç”Ÿåœ¨ k6 æ”¶åˆ°å“åº”æ­£æ–‡æœ«å°¾æˆ–è¯·æ±‚è¶…æ—¶æ—¶ã€‚

ä¸‹è¡¨åˆ—å‡ºäº† HTTP ç‰¹å®šçš„å†…ç½®æŒ‡æ ‡ï¼š

| æŒ‡æ ‡åç§° | æŒ‡æ ‡åˆ†ç±» | æŒ‡æ ‡æè¿° |
| ------- | ------- | -------|
|http_reqs|Counter|k6 æ€»å…±ç”Ÿæˆäº†å¤šå°‘ä¸ª HTTP è¯·æ±‚ã€‚|
|http_req_blocked|Trend|åœ¨å‘èµ·è¯·æ±‚ä¹‹å‰é˜»å¡ï¼ˆç­‰å¾…ç©ºé—² TCP è¿æ¥æ§½ï¼‰æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚`float`ç±»å‹|
|http_req_connecting|Trend |ä¸è¿œç¨‹ä¸»æœºå»ºç«‹ TCP è¿æ¥æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚`float`ç±»å‹|
|http_req_tls_handshaking|Trend|ä¸è¿œç¨‹ä¸»æœºæ¡æ‰‹ TLS ä¼šè¯æ‰€èŠ±è´¹çš„æ—¶é—´|
|http_req_sending|Trend|å‘è¿œç¨‹ä¸»æœºå‘é€æ•°æ®æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚`float`ç±»å‹|
|http_req_waiting|Trend|ç­‰å¾…è¿œç¨‹ä¸»æœºå“åº”æ‰€èŠ±è´¹çš„æ—¶é—´ï¼ˆä¹Ÿç§°ä¸ºâ€œç¬¬ä¸€ä¸ªå­—èŠ‚çš„æ—¶é—´â€æˆ–â€œTTFBâ€ï¼‰ã€‚`float`ç±»å‹|
|http_req_receiving|Trend|ä»è¿œç¨‹ä¸»æœºæ¥æ”¶å“åº”æ•°æ®æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚`float`ç±»å‹|
|http_req_duration|Trend|è¯·æ±‚çš„æ€»æ—¶é—´ã€‚å®ƒç­‰äº http_req_sending + http_req_waiting + http_req_receivingï¼ˆå³è¿œç¨‹æœåŠ¡å™¨å¤„ç†è¯·æ±‚å’Œå“åº”æ‰€éœ€çš„æ—¶é—´ï¼Œæ²¡æœ‰åˆå§‹ DNS æŸ¥æ‰¾/è¿æ¥æ—¶é—´ï¼‰ã€‚`float`ç±»å‹|
|http_req_failed|Rate|æ ¹æ® setResponseCallback çš„å¤±è´¥è¯·æ±‚ç‡ã€‚|

> æŒ‡æ ‡åˆ†ç±»åˆ†åˆ«ä¸ºï¼šè®¡æ•°å™¨ï¼ˆCounterï¼‰ã€è®¡é‡å™¨ï¼ˆGaugesï¼‰ã€æ¯”ç‡ï¼ˆRatesï¼‰ã€è¶‹åŠ¿ï¼ˆTrendsï¼‰

##### å…¶ä»–å†…ç½®æŒ‡æ ‡

K6 å†…ç½®æŒ‡æ ‡é™¤äº†æ ‡å‡†å†…ç½®æŒ‡æ ‡å’Œ HTTP ç‰¹å®šçš„å†…ç½®æŒ‡æ ‡å¤–ï¼Œè¿˜æœ‰å…¶ä»–å†…ç½®æŒ‡æ ‡ï¼š

- Browser metrics æµè§ˆå™¨æŒ‡æ ‡ï¼š<https://grafana.com/docs/k6/latest/using-k6/metrics/reference/#browser>
- Built-in WebSocket metrics å†…ç½® WebSocket æŒ‡æ ‡ï¼š<https://grafana.com/docs/k6/latest/using-k6/metrics/reference/#websockets>
- Built-in gRPC metrics å†…ç½® gRPC æŒ‡æ ‡ï¼š<https://grafana.com/docs/k6/latest/using-k6/metrics/reference/#grpc>

#### è‡ªå®šä¹‰æŒ‡æ ‡

é™¤äº†ç³»ç»Ÿå†…å»ºçš„æŒ‡æ ‡ä¹‹å¤–ï¼Œæ‚¨è¿˜å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰æŒ‡æ ‡ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥è®¡ç®—ä¸ä¸šåŠ¡é€»è¾‘ç›¸å…³çš„æŒ‡æ ‡ï¼Œæˆ–è€…åˆ©ç”¨ Response.timings å¯¹è±¡ä¸ºç‰¹å®šçš„ä¸€ç»„ç«¯ç‚¹åˆ›å»ºæŒ‡æ ‡ã€‚

æ¯ç§æŒ‡æ ‡ç±»å‹éƒ½æœ‰ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œç”¨äºç”Ÿæˆè‡ªå®šä¹‰æŒ‡æ ‡ã€‚è¯¥æ„é€ å‡½æ•°ä¼šç”Ÿæˆä¸€ä¸ªå£°æ˜ç±»å‹çš„æŒ‡æ ‡å¯¹è±¡ã€‚æ¯ç§ç±»å‹éƒ½æœ‰ä¸€ä¸ª add æ–¹æ³•ï¼Œç”¨äºè®°å½•æŒ‡æ ‡æµ‹é‡å€¼ã€‚

> æ³¨æ„ï¼šå¿…é¡»åœ¨ init ä¸Šä¸‹æ–‡ä¸­åˆ›å»ºè‡ªå®šä¹‰æŒ‡æ ‡ã€‚è¿™ä¼šé™åˆ¶å†…å­˜å¹¶ç¡®ä¿ K6 å¯ä»¥éªŒè¯æ‰€æœ‰é˜ˆå€¼æ˜¯å¦è¯„ä¼°äº†å®šä¹‰çš„æŒ‡æ ‡ã€‚

##### è‡ªå®šä¹‰æŒ‡æ ‡ demo ç¤ºä¾‹

ä»¥ä¸‹ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•åˆ›å»ºç­‰å¾…æ—¶é—´çš„è‡ªå®šä¹‰è¶‹åŠ¿æŒ‡æ ‡ï¼š

> é¡¹ç›®æ–‡ä»¶ä¸­çš„ demo_custom_metrics.js æ–‡ä»¶å·²ç»åŒ…å«äº†è¿™ä¸ª demo ç¤ºä¾‹ï¼Œå¯ä»¥ç›´æ¥è¿è¡ŒæŸ¥çœ‹ç»“æœã€‚

###### 1.ä»å¯¼å…¥ k6/metrics æ¨¡å—å¼•å…¥ Trend æ„é€ å‡½æ•°

```javascript
import { Trend } from 'k6/metrics';
```

> ç­‰å¾…æ—¶é—´è¶‹åŠ¿æŒ‡æ ‡å±äºè¶‹åŠ¿ï¼ˆTrendsï¼‰æŒ‡æ ‡ï¼Œæ‰€ä»¥éœ€è¦ä» k6/metrics æ¨¡å—å¼•å…¥ Trend æ„é€ å‡½æ•°ã€‚

###### 2.åœ¨ init ä¸Šä¸‹æ–‡ä¸­æ„é€ ä¸€ä¸ªæ–°çš„è‡ªå®šä¹‰åº¦é‡ Trend å¯¹è±¡

```javascript
const myTrend = new Trend('waiting_time');
```

> åœ¨ init ä¸Šä¸‹æ–‡ä¸­æ„é€ ä¸€ä¸ªæ–°çš„è‡ªå®šä¹‰åº¦é‡ Trend å¯¹è±¡ï¼Œè„šæœ¬ä¸­çš„å¯¹è±¡ä¸º myTrendï¼Œå…¶æŒ‡æ ‡åœ¨ç»“æœè¾“å‡ºä¸­æ˜¾ç¤ºä¸º `waiting_time`ã€‚

###### 3.åœ¨è„šæœ¬ä¸­ä½¿ç”¨ add æ–¹æ³•è®°å½•æŒ‡æ ‡æµ‹é‡å€¼

```javascript
export default function() {
  const res = http.get('https://test.k6.io');
  myTrend.add(res.timings.waiting);
}
```

> åœ¨è„šæœ¬ä¸­ä½¿ç”¨ add æ–¹æ³•è®°å½•æŒ‡æ ‡æµ‹é‡å€¼ï¼Œè¿™é‡Œä½¿ç”¨äº† `res.timings.waiting`ï¼Œå³ç­‰å¾…æ—¶é—´ã€‚

###### 4.demo_custom_metrics.js è‡ªå®šä¹‰æŒ‡æ ‡å®Œæ•´ä»£ç 

```javascript
import http from 'k6/http';
import { Trend } from 'k6/metrics';

const myTrend = new Trend('waiting_time');

export default function () {
  const res = http.get('https://httpbin.test.k6.io');
  myTrend.add(res.timings.waiting);
  console.log(myTrend.name); // waiting_time
}
```

###### 5.è¿è¡Œ demo_custom_metrics.js å¹¶æŸ¥çœ‹è‡ªåŠ¨åŒ–è¶‹åŠ¿æŒ‡æ ‡

```bash
k6 run demo_custom_metrics.js
```

è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

![ ](https://cdn.jsdelivr.net/gh/naodeng/blogimg@master/uPic/4tbqVc.png)

> å¯ä»¥çœ‹åˆ°ï¼Œè‡ªå®šä¹‰æŒ‡æ ‡ `waiting_time` å·²ç»åœ¨ç»“æœè¾“å‡ºä¸­æ˜¾ç¤ºå‡ºæ¥äº†ã€‚

æ›´å¤šå…³äºè‡ªå®šä¹‰æŒ‡æ ‡çš„å†…å®¹ï¼Œè¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š[https://k6.io/docs/using-k6/metrics/#custom-metrics](https://k6.io/docs/using-k6/metrics/#custom-metrics)

## å‚è€ƒèµ„æ–™

- [K6 å®˜æ–¹æ–‡æ¡£ï¼šhttps://k6.io/docs/](https://k6.io/docs/)
- [å®˜æ–¹ç½‘ç«™ï¼šhttps://k6.io/](https://k6.io/)
